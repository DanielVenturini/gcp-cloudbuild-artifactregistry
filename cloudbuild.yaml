logsBucket: gs://gcloud-build-python-image-build-logs

steps:
  - name: python:3.13.12-alpine3.23
    id: Create virtual environment
    entrypoint: python
    args: ['-m', 'venv', '.venv']

  - name: python:3.13.12-alpine3.23
    id: Install project dependencies
    entrypoint: .venv/bin/pip3
    args: ['install','-r','requirements.txt']

  - name: python:3.13.12-alpine3.23
    id: Performe PyTests
    entrypoint: .venv/bin/pytest
    args: ['tests/']

  - name: gcr.io/cloud-builders/docker
    id: Build container image
    args:
      - build
      - -t
      - us-south1-docker.pkg.dev/venturini-brazil/flask-app/web-api:$BUILD_ID
      - -t
      - us-south1-docker.pkg.dev/venturini-brazil/flask-app/web-api:latest
      - .

  - name: gcr.io/cloud-builders/docker
    id: Store container image with BUILD_ID tag
    args:
      - push
      - us-south1-docker.pkg.dev/venturini-brazil/flask-app/web-api:$BUILD_ID

  - name: gcr.io/cloud-builders/docker
    id: Store container image with latest tag
    args:
      - push
      - us-south1-docker.pkg.dev/venturini-brazil/flask-app/web-api:latest

  - name: gcr.io/cloud-builders/gcloud
    id: Login into Artifacts Registry
    entrypoint: bash
    args:
      - -c
      - |
        for instance in $(gcloud compute instances list --format="table(name)" | grep -v NAME); do
          gcloud compute ssh danielventurini021@$instance \
            --zone us-central1-a \
            --command "
              gcloud auth print-access-token \
              --impersonate-service-account 168912158152-compute@developer.gserviceaccount.com | docker login \
              -u oauth2accesstoken \
              --password-stdin https://us-south1-docker.pkg.dev
            "
        done

  - name: gcr.io/cloud-builders/gcloud
    id: Deploy into Cloud Engine
    entrypoint: bash
    args:
      - -c
      - |
        for instance in $(gcloud compute instances list --format="table(name)" | grep -v NAME); do
          gcloud compute ssh danielventurini021@$instance \
            --zone us-central1-a \
            --command "
              docker compose down -v
              sed -Ei "s,web-api:.*$,web-api:$BUILD_ID,g" docker-compose.yaml
              docker compose up -d
            "
        done
